generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = "file:../data/cvnl_discord.db"
}

model User {
    id             Int          @id @default(autoincrement())
    discordId      String
    token          String
    cvnlUserId     String
    cvnlUserName   String
    cvnlUserGender String?
    cvnlUserJob    Int?
    cvnlUserAge    Int?
    createdAt      DateTime     @default(now())
    chatThreads    ChatThread[]
    UserChannel    UserChannel?

    @@unique([discordId, cvnlUserId])
    @@map("users")
}

model OAuthSession {
    id           Int      @id @default(autoincrement())
    discordId    String   @unique
    accessToken  String
    refreshToken String
    expiresAt    Int
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@map("oauth_sessions")
}

model UserChannel {
    id          Int      @id @default(autoincrement())
    discordId   String
    cvnlUserId  String
    channelId   String   @unique
    channelName String
    guildId     String
    createdAt   DateTime @default(now())

    user User @relation(fields: [discordId, cvnlUserId], references: [discordId, cvnlUserId])

    @@unique([discordId, cvnlUserId]) // Composite unique key
    @@map("user_channels")
}

model ChatThread {
    id          Int             @id @default(autoincrement())
    status      Int             @default(0) // 0: active, 1: closed
    chatId      String
    threadId    String          @unique
    discordId   String
    channelId   String
    threadName  String
    createdAt   DateTime        @default(now())
    user        User            @relation(fields: [discordId, cvnlUserId], references: [discordId, cvnlUserId])
    cvnlUserId  String
    reOpenCount Int             @default(0)
    messages    ThreadMessage[]

    @@unique([chatId, cvnlUserId])
    @@map("chat_threads")
}

model ThreadMessage {
    threadId     String
    discordMsgId String     @unique
    cvnlMsgId    String
    thread       ChatThread @relation(fields: [threadId], references: [threadId])

    @@unique([threadId, cvnlMsgId])
    @@id([discordMsgId, cvnlMsgId])
    @@map("thread_messages")
}
